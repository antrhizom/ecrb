<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interaktive Lern-App zum Schweizer Urheberrecht">
    <title>Urheberrecht Lern-App - Start</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon" role="img" aria-label="Gesetzbuch">üìö</div>
                <h1 class="login-title">Urheberrecht Lern-App</h1>
                <p class="login-subtitle">Schweizer Urheberrecht interaktiv lernen</p>
            </div>

            <!-- Code eingeben f√ºr R√ºckkehr - JETZT ZUERST! -->
            <div id="existing-code-section">
                <details style="border: 2px solid var(--zh-blue); border-radius: 8px; padding: 16px; background: var(--zh-gray-light); margin-bottom: 24px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 15px; color: var(--zh-blue);">
                        üì± Bereits einen Code? Hier anmelden ‚Üí
                    </summary>
                    <div style="margin-top: 16px;">
                        <label for="existing-code" class="form-label">Ihr Zugangs-Code:</label>
                        <input 
                            type="text" 
                            id="existing-code" 
                            class="form-input" 
                            placeholder="z.B. 7aK9mP2xQ5-42"
                            style="font-family: 'Courier New', monospace; letter-spacing: 1px;"
                        >
                        <button class="btn btn-primary" onclick="loginWithCode()" style="width: 100%; margin-top: 12px;">
                            Mit Code anmelden ‚Üí
                        </button>
                        <div id="code-error" class="error-message"></div>
                    </div>
                </details>
            </div>

            <!-- Namen eingeben Bereich -->
            <div id="name-input-section">
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="font-size: 14px; color: #666;">Oder neu starten:</p>
                </div>
                
                <div style="margin: 24px 0;">
                    <h2 style="font-size: 18px; color: var(--zh-blue); margin-bottom: 16px; text-align: center;">
                        Willkommen! üëã
                    </h2>
                    <p style="font-size: 14px; color: #666; text-align: center; margin-bottom: 24px;">
                        Wie d√ºrfen wir Sie nennen?
                    </p>
                    
                    <div class="form-group">
                        <label for="user-name" class="form-label">Ihr Name (optional):</label>
                        <input 
                            type="text" 
                            id="user-name" 
                            class="form-input" 
                            placeholder="z.B. Anna M√ºller"
                            maxlength="50"
                            autocomplete="name"
                        >
                        <p style="font-size: 12px; color: #888; margin-top: 8px;">
                            Der Name erscheint auf Ihrem Zertifikat. Sie k√∂nnen auch anonym bleiben.
                        </p>
                    </div>

                    <button class="btn btn-primary btn-large" onclick="startWithName()" style="width: 100%; margin-top: 8px;">
                        Neu starten ‚Üí
                    </button>
                </div>
            </div>

            <!-- Automatischer Code-Login Bereich -->
            <div id="auto-login-section" style="display: none;">
                <div style="text-align: center; margin: 32px 0;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px; color: #666;">Login l√§uft...</p>
                    </div>
                </div>
            </div>

            <!-- Code-Anzeige nach Login -->
            <div id="code-display-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #e8f2ff 0%, #f0f7ff 100%); border: 2px solid var(--zh-blue); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                        <strong>‚úì Ihr pers√∂nlicher Zugangs-Code:</strong>
                    </p>
                    <div id="user-code" style="font-size: 28px; font-weight: 700; color: var(--zh-blue); font-family: 'Courier New', monospace; letter-spacing: 2px; margin: 16px 0; padding: 16px; background: white; border-radius: 8px; word-break: break-all;">
                        L√§dt...
                    </div>
                    <p style="font-size: 12px; color: #888; line-height: 1.6;">
                        Speichern Sie diesen Code! Sie brauchen ihn, um sp√§ter weiterzumachen.
                    </p>
                    <button class="btn btn-secondary" onclick="copyCode()" style="margin-top: 16px; width: 100%;">
                        üìã Code kopieren
                    </button>
                </div>

                <button class="btn btn-primary btn-large" onclick="startLearning()" style="width: 100%;">
                    Jetzt lernen starten! ‚Üí
                </button>
            </div>

            <!-- Info Box -->
            <div class="login-info" style="margin-top: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px; font-size: 13px; color: #666;">
                <p style="margin-bottom: 8px;"><strong>‚ÑπÔ∏è Wie funktioniert's?</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><strong>Mit Code:</strong> Geben Sie Ihren Code oben ein</li>
                    <li><strong>Neu starten:</strong> Namen eingeben (optional) und loslegen</li>
                    <li>4 Module, Punktesystem, Zertifikat</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        let currentUserCode = null;
        let userName = null;

        function generateReadableCode(uid) {
            const shortUid = uid.substring(0, 10);
            const checksum = uid.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 100;
            return `${shortUid}-${checksum.toString().padStart(2, '0')}`;
        }

        function startWithName() {
            userName = document.getElementById('user-name').value.trim();
            if (userName) localStorage.setItem('userName', userName);
            document.getElementById('name-input-section').style.display = 'none';
            document.getElementById('auto-login-section').style.display = 'block';
            autoLogin();
        }

        async function autoLogin() {
            try {
                if (auth.currentUser) {
                    showCodeAndProceed(auth.currentUser);
                    return;
                }

                const savedCode = localStorage.getItem('userAccessCode');
                const savedName = localStorage.getItem('userName');
                
                if (savedCode && savedName) {
                    userName = savedName;
                    document.getElementById('auto-login-section').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: var(--zh-blue); font-weight: 600; margin-bottom: 16px;">
                                ‚úì Willkommen zur√ºck, ${savedName}!
                            </p>
                            <p style="font-size: 13px; color: #666;">
                                Code: <strong style="font-family: 'Courier New', monospace;">${savedCode}</strong>
                            </p>
                        </div>
                    `;
                    await new Promise(resolve => setTimeout(resolve, 800));
                }

                const userCredential = await auth.signInAnonymously();
                const user = userCredential.user;

                currentUserCode = generateReadableCode(user.uid);
                localStorage.setItem('userAccessCode', currentUserCode);
                localStorage.setItem('userId', user.uid);

                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();

                if (!userDoc.exists) {
                    await userRef.set({
                        name: userName || 'Anonym',
                        accessCode: currentUserCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        modules: {
                            modul1: { completed: false, score: 0, progress: 0 },
                            modul2: { completed: false, score: 0, progress: 0 },
                            modul3: { completed: false, score: 0, progress: 0 },
                            modul4: { completed: false, score: 0, progress: 0 }
                        },
                        totalPoints: 0,
                        overallProgress: 0
                    });
                } else {
                    const updateData = { lastLogin: firebase.firestore.FieldValue.serverTimestamp() };
                    if (userName) updateData.name = userName;
                    await userRef.update(updateData);
                    
                    const data = userDoc.data();
                    if (data.accessCode) {
                        currentUserCode = data.accessCode;
                        localStorage.setItem('userAccessCode', currentUserCode);
                    }
                    if (data.name) {
                        userName = data.name;
                        localStorage.setItem('userName', data.name);
                    }
                }

                showCodeAndProceed(user);

            } catch (error) {
                console.error('Auto-login error:', error);
                showError('Login fehlgeschlagen. Bitte Seite neu laden.');
            }
        }

        function showCodeAndProceed(user) {
            document.getElementById('auto-login-section').style.display = 'none';
            document.getElementById('code-display-section').style.display = 'block';
            // existing-code-section bleibt sichtbar f√ºr einfachen Zugriff
            
            document.getElementById('user-code').textContent = currentUserCode;
            
            if (userName) {
                const codeDisplay = document.getElementById('code-display-section');
                const greeting = document.createElement('div');
                greeting.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 16px; background: #f0f7ff; border-radius: 8px;';
                greeting.innerHTML = `<p style="color: var(--zh-blue); font-weight: 600; font-size: 16px;">Hallo ${userName}! üëã</p>`;
                codeDisplay.insertBefore(greeting, codeDisplay.firstChild);
            }
        }

        function copyCode() {
            const codeText = document.getElementById('user-code').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(codeText).then(() => showToast('‚úì Code kopiert!')).catch(() => fallbackCopyCode(codeText));
            } else {
                fallbackCopyCode(codeText);
            }
        }

        function fallbackCopyCode(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.cssText = 'position:fixed;opacity:0';
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); showToast('‚úì Code kopiert!'); } 
            catch { showToast('‚ö†Ô∏è Bitte Code manuell kopieren'); }
            document.body.removeChild(textarea);
        }

        async function loginWithCode() {
            const code = document.getElementById('existing-code').value.trim();
            const errorDiv = document.getElementById('code-error');
            if (!code) { 
                errorDiv.textContent = 'Bitte Code eingeben'; 
                errorDiv.classList.add('show'); 
                return; 
            }

            const loginBtn = event.target;
            loginBtn.disabled = true;
            loginBtn.textContent = 'Anmeldung l√§uft...';

            try {
                // SCHRITT 1: Anonymous Login GARANTIEREN
                console.log('üîê Step 1: Checking auth...');
                
                if (!auth.currentUser) {
                    console.log('‚ö†Ô∏è Not logged in, signing in anonymously...');
                    const userCredential = await auth.signInAnonymously();
                    console.log('‚úì Anonymous login successful:', userCredential.user.uid);
                    
                    // WICHTIG: Kurz warten damit Firebase Auth sich setzt
                    await new Promise(resolve => setTimeout(resolve, 500));
                } else {
                    console.log('‚úì Already logged in:', auth.currentUser.uid);
                }
                
                // SCHRITT 2: Nochmal pr√ºfen ob Auth wirklich da ist
                if (!auth.currentUser) {
                    throw new Error('Authentication failed - please reload page');
                }
                
                // SCHRITT 3: Code suchen (JETZT mit Auth!)
                console.log('üîç Step 2: Searching for code:', code);
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('accessCode', '==', code).limit(1).get();
                
                console.log('üìä Search results:', snapshot.size);
                
                if (snapshot.empty) {
                    throw new Error('Code nicht gefunden');
                }

                // SCHRITT 4: User-Daten laden
                const userDoc = snapshot.docs[0];
                const userId = userDoc.id;
                const userData = userDoc.data();
                
                console.log('‚úì User found:', userId);

                // SCHRITT 5: Daten speichern
                localStorage.setItem('userAccessCode', code);
                localStorage.setItem('userId', userId);
                if (userData.name) {
                    localStorage.setItem('userName', userData.name);
                    console.log('‚úì Name loaded:', userData.name);
                }
                currentUserCode = code;

                // SCHRITT 6: Last login updaten
                await db.collection('users').doc(userId).update({ 
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                console.log('‚úì Login successful!');

                // SCHRITT 7: Weiterleiten
                showToast('‚úì Erfolgreich angemeldet!');
                setTimeout(() => window.location.href = 'dashboard.html', 800);

            } catch (error) {
                console.error('‚ùå Login with code error:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMsg = 'Ung√ºltiger Code oder Verbindungsfehler';
                
                if (error.code === 'permission-denied') {
                    errorMsg = 'üîí Berechtigungsfehler!\n\nBitte pr√ºfen:\n1. Firestore Rules gesetzt?\n2. Anonymous Auth aktiviert?';
                    console.error('üîí PERMISSION DENIED - Check Firebase Rules!');
                } else if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    errorMsg = 'üìä Index fehlt!\n\nFirestore Index muss erstellt werden.\nBitte Console pr√ºfen f√ºr Link.';
                    console.error('üìä INDEX REQUIRED - Check console for link!');
                } else if (error.message.includes('nicht gefunden')) {
                    errorMsg = '‚ùå Code nicht gefunden.\n\nBitte Code pr√ºfen:\n- Richtig eingegeben?\n- Bindestrich vorhanden?';
                } else if (error.message.includes('Authentication failed')) {
                    errorMsg = '‚ö†Ô∏è Authentication fehlgeschlagen.\n\nBitte Seite neu laden.';
                }
                
                errorDiv.textContent = errorMsg;
                errorDiv.classList.add('show');
                errorDiv.style.whiteSpace = 'pre-line'; // F√ºr Zeilenumbr√ºche
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'Mit Code anmelden ‚Üí';
                
                setTimeout(() => errorDiv.classList.remove('show'), 8000);
            }
        }

        function startLearning() { window.location.href = 'dashboard.html'; }

        function showError(message) {
            document.getElementById('auto-login-section').innerHTML = `
                <div style="background: #ffe6e6; border: 2px solid var(--zh-red); padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: var(--zh-red); font-weight: 600; margin-bottom: 12px;">‚ö†Ô∏è Fehler</p>
                    <p style="font-size: 14px; color: #666;">${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">Seite neu laden</button>
                </div>
            `;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #00994d; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; font-weight: 600; z-index: 1000; animation: slideInUp 0.3s;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOutDown 0.3s'; setTimeout(() => toast.remove(), 300); }, 2500);
        }

        auth.onAuthStateChanged((user) => {
            if (user && window.location.pathname.includes('index.html')) {
                const savedCode = localStorage.getItem('userAccessCode');
                const savedName = localStorage.getItem('userName');
                if (savedCode) {
                    currentUserCode = savedCode;
                    userName = savedName;
                    document.getElementById('name-input-section').style.display = 'none';
                    document.getElementById('auto-login-section').style.display = 'block';
                    showCodeAndProceed(user);
                } else {
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists && doc.data().accessCode) {
                            currentUserCode = doc.data().accessCode;
                            userName = doc.data().name || 'Anonym';
                            localStorage.setItem('userAccessCode', currentUserCode);
                            localStorage.setItem('userName', userName);
                            document.getElementById('name-input-section').style.display = 'none';
                            document.getElementById('auto-login-section').style.display = 'block';
                            showCodeAndProceed(user);
                        }
                    });
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-name')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') startWithName(); });
        });

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('existing-code') === document.activeElement) loginWithCode();
        });
    </script>
</body>
</html>
