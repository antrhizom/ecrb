<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interaktive Lern-App zum Schweizer Urheberrecht">
    <title>Urheberrecht Lern-App - Start</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon" role="img" aria-label="Gesetzbuch">üìö</div>
                <h1 class="login-title">Urheberrecht Lern-App</h1>
                <p class="login-subtitle">Schweizer Urheberrecht interaktiv lernen</p>
            </div>

            <!-- Automatischer Code-Login Bereich -->
            <div id="auto-login-section">
                <div style="text-align: center; margin: 32px 0;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px; color: #666;">Automatischer Login l√§uft...</p>
                    </div>
                </div>
            </div>

            <!-- Code-Anzeige nach Login -->
            <div id="code-display-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #e8f2ff 0%, #f0f7ff 100%); border: 2px solid var(--zh-blue); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                        <strong>‚úì Ihr pers√∂nlicher Zugangs-Code:</strong>
                    </p>
                    <div id="user-code" style="font-size: 28px; font-weight: 700; color: var(--zh-blue); font-family: 'Courier New', monospace; letter-spacing: 2px; margin: 16px 0; padding: 16px; background: white; border-radius: 8px; word-break: break-all;">
                        L√§dt...
                    </div>
                    <p style="font-size: 12px; color: #888; line-height: 1.6;">
                        Speichern Sie diesen Code! Sie brauchen ihn, um sp√§ter weiterzumachen.
                    </p>
                    <button class="btn btn-secondary" onclick="copyCode()" style="margin-top: 16px; width: 100%;">
                        üìã Code kopieren
                    </button>
                </div>

                <button class="btn btn-primary btn-large" onclick="startLearning()" style="width: 100%;">
                    Jetzt lernen starten! ‚Üí
                </button>
            </div>

            <!-- Code eingeben f√ºr R√ºckkehr -->
            <div id="return-login-section" style="display: none; margin-top: 32px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="font-size: 14px; color: #666;">Oder</p>
                </div>
                
                <details style="border: 1px solid var(--zh-border); border-radius: 8px; padding: 16px; background: var(--zh-gray-light);">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 14px; color: var(--zh-blue);">
                        Bereits einen Code? Hier fortfahren ‚Üí
                    </summary>
                    <div style="margin-top: 16px;">
                        <label for="existing-code" class="form-label">Ihr Zugangs-Code:</label>
                        <input 
                            type="text" 
                            id="existing-code" 
                            class="form-input" 
                            placeholder="z.B. 7aK9mP2xQ5-42"
                            style="font-family: 'Courier New', monospace; letter-spacing: 1px;"
                        >
                        <button class="btn btn-primary" onclick="loginWithCode()" style="width: 100%; margin-top: 12px;">
                            Mit Code anmelden ‚Üí
                        </button>
                        <div id="code-error" class="error-message"></div>
                    </div>
                </details>
            </div>

            <!-- Info Box -->
            <div class="login-info" style="margin-top: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px; font-size: 13px; color: #666;">
                <p style="margin-bottom: 8px;"><strong>‚ÑπÔ∏è Wie funktioniert's?</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Automatischer Login - kein Passwort n√∂tig</li>
                    <li>Sie erhalten einen pers√∂nlichen Code</li>
                    <li>Code speichern, um sp√§ter fortzufahren</li>
                    <li>4 Module, Punktesystem, Zertifikat</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    
    <script>
        let currentUserCode = null;

        // Generiere lesbaren Code aus UID
        function generateReadableCode(uid) {
            // Erste 10 Zeichen des UIDs + Pr√ºfsumme
            const shortUid = uid.substring(0, 10);
            const checksum = uid.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 100;
            return `${shortUid}-${checksum.toString().padStart(2, '0')}`;
        }

        // Extrahiere UID aus Code
        function extractUidFromCode(code) {
            const parts = code.trim().split('-');
            if (parts.length !== 2) return null;
            return parts[0];
        }

        // Automatischer anonymer Login
        async function autoLogin() {
            try {
                // Pr√ºfe ob bereits eingeloggt
                if (auth.currentUser) {
                    showCodeAndProceed(auth.currentUser);
                    return;
                }

                // Pr√ºfe localStorage f√ºr gespeicherten Code
                const savedCode = localStorage.getItem('userAccessCode');
                if (savedCode) {
                    document.getElementById('auto-login-section').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: var(--zh-blue); font-weight: 600; margin-bottom: 16px;">
                                ‚úì Willkommen zur√ºck!
                            </p>
                            <p style="font-size: 13px; color: #666;">
                                Ihr gespeicherter Code: <strong style="font-family: 'Courier New', monospace;">${savedCode}</strong>
                            </p>
                        </div>
                    `;
                    
                    await new Promise(resolve => setTimeout(resolve, 800));
                }

                // Firebase Anonymous Auth
                const userCredential = await auth.signInAnonymously();
                const user = userCredential.user;

                // Generiere lesbaren Code
                currentUserCode = generateReadableCode(user.uid);
                
                // Speichere Code in localStorage
                localStorage.setItem('userAccessCode', currentUserCode);
                localStorage.setItem('userId', user.uid);

                // Erstelle User-Dokument in Firestore
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();

                if (!userDoc.exists) {
                    await userRef.set({
                        accessCode: currentUserCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        modules: {
                            modul1: { completed: false, score: 0, progress: 0 },
                            modul2: { completed: false, score: 0, progress: 0 },
                            modul3: { completed: false, score: 0, progress: 0 },
                            modul4: { completed: false, score: 0, progress: 0 }
                        },
                        totalPoints: 0,
                        overallProgress: 0
                    });
                } else {
                    await userRef.update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const data = userDoc.data();
                    if (data.accessCode) {
                        currentUserCode = data.accessCode;
                        localStorage.setItem('userAccessCode', currentUserCode);
                    }
                }

                showCodeAndProceed(user);

            } catch (error) {
                console.error('Auto-login error:', error);
                showError('Automatischer Login fehlgeschlagen. Bitte Seite neu laden.');
            }
        }

        // Zeige Code und Fortsetzungs-Button
        function showCodeAndProceed(user) {
            document.getElementById('auto-login-section').style.display = 'none';
            document.getElementById('code-display-section').style.display = 'block';
            document.getElementById('return-login-section').style.display = 'block';
            
            document.getElementById('user-code').textContent = currentUserCode;
        }

        // Code kopieren
        function copyCode() {
            const codeText = document.getElementById('user-code').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(codeText).then(() => {
                    showToast('‚úì Code kopiert!');
                }).catch(() => {
                    fallbackCopyCode(codeText);
                });
            } else {
                fallbackCopyCode(codeText);
            }
        }

        // Fallback f√ºr √§ltere Browser
        function fallbackCopyCode(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('‚úì Code kopiert!');
            } catch (err) {
                showToast('‚ö†Ô∏è Bitte Code manuell kopieren');
            }
            
            document.body.removeChild(textarea);
        }

        // Mit existierendem Code anmelden
        async function loginWithCode() {
            const code = document.getElementById('existing-code').value.trim();
            const errorDiv = document.getElementById('code-error');
            
            if (!code) {
                errorDiv.textContent = 'Bitte Code eingeben';
                errorDiv.classList.add('show');
                return;
            }

            try {
                // Suche User in Firestore mit diesem Code
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('accessCode', '==', code).limit(1).get();

                if (snapshot.empty) {
                    throw new Error('Code nicht gefunden');
                }

                const userDoc = snapshot.docs[0];
                const userId = userDoc.id;

                // Speichere Code und UID
                localStorage.setItem('userAccessCode', code);
                localStorage.setItem('userId', userId);
                currentUserCode = code;

                // Update last login
                await db.collection('users').doc(userId).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Direkt zum Dashboard
                showToast('‚úì Erfolgreich angemeldet!');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 800);

            } catch (error) {
                console.error('Login with code error:', error);
                errorDiv.textContent = 'Ung√ºltiger Code oder Verbindungsfehler';
                errorDiv.classList.add('show');
                
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            }
        }

        // Zum Dashboard
        function startLearning() {
            window.location.href = 'dashboard.html';
        }

        // Error anzeigen
        function showError(message) {
            document.getElementById('auto-login-section').innerHTML = `
                <div style="background: #ffe6e6; border: 2px solid var(--zh-red); padding: 20px; border-radius: 8px; text-align: center;">
                    <p style="color: var(--zh-red); font-weight: 600; margin-bottom: 12px;">‚ö†Ô∏è Fehler</p>
                    <p style="font-size: 14px; color: #666;">${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">
                        Seite neu laden
                    </button>
                </div>
            `;
        }

        // Toast-Nachricht
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; background: #00994d;
                color: white; padding: 16px 24px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px;
                font-weight: 600; z-index: 1000; animation: slideInUp 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Check ob User bereits eingeloggt ist
        auth.onAuthStateChanged((user) => {
            if (user && window.location.pathname.includes('index.html')) {
                const savedCode = localStorage.getItem('userAccessCode');
                if (savedCode) {
                    currentUserCode = savedCode;
                    showCodeAndProceed(user);
                } else {
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists && doc.data().accessCode) {
                            currentUserCode = doc.data().accessCode;
                            localStorage.setItem('userAccessCode', currentUserCode);
                            showCodeAndProceed(user);
                        } else {
                            currentUserCode = generateReadableCode(user.uid);
                            localStorage.setItem('userAccessCode', currentUserCode);
                            db.collection('users').doc(user.uid).update({
                                accessCode: currentUserCode
                            });
                            showCodeAndProceed(user);
                        }
                    });
                }
            }
        });

        // Auto-login beim Laden
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(autoLogin, 500);
        });

        // Enter-Taste f√ºr Code-Eingabe
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('existing-code') === document.activeElement) {
                loginWithCode();
            }
        });
    </script>
</body>
</html>
